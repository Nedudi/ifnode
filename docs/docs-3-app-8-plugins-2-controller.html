<h2 id="controller-plugin">Controller plugin</h2>
<p>Possibility to create own controller plugin to <code>ifnode</code>.</p>
<h3 id="creating-own-plugin">Creating own plugin</h3>
<p>Below example of simple plugin <code>ip-filter</code> for filter access by user ip.</p>
<p>Plugin file:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// extensions/ip-filter</span>
<span class="hljs-built_in">module</span>.exports.controller = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app, Controller</span>) </span>{
    <span class="hljs-comment">// check needed controller plugin options</span>
    Controller.process_config(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">controller_config</span>) </span>{
        <span class="hljs-keyword">if</span>(is_invalid_ip(controller_config.forbidden_ip)) {
            <span class="hljs-keyword">delete</span> controller_config.forbidden_ip;
        }

        <span class="hljs-keyword">if</span>(is_invalid_ip(controller_config.skip_ip)) {
            <span class="hljs-keyword">delete</span> controller_config.skip_ip;
        }
    });

    <span class="hljs-comment">// populate by own methods/properties request or response</span>
    Controller.populate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next_handler, next_route</span>) </span>{
        request.user_ip = request.headers[<span class="hljs-string">'x-forwarded-for'</span>] ||
            request.connection.remoteAddress ||
            request.socket.remoteAddress ||
            request.connection.socket.remoteAddress;

        response.forbidden_ip_address = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.status(<span class="hljs-number">401</span>).send(<span class="hljs-string">"Access denied for user's ip"</span>);
        };
    });

    <span class="hljs-comment">// set controller middleware</span>
    Controller.middleware(
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">controller_options</span>) </span>{
            <span class="hljs-keyword">var</span> forbidden_ip = controller_options.forbidden_ip;

            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next_handler, next_route</span>) </span>{
                <span class="hljs-keyword">if</span>(request.user_ip === forbidden_id) {
                    <span class="hljs-keyword">return</span> response.forbidden_ip_address();
                }

                next_handler();
            };
        },
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">controller_options</span>) </span>{
            <span class="hljs-keyword">var</span> skip_ip = controller_options.skip_ip;

            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response, next_handler, next_route</span>) </span>{
                <span class="hljs-keyword">if</span>(request.user_ip === skip_ip) {
                    <span class="hljs-keyword">return</span> next_route(); <span class="hljs-comment">// jump to next route</span>
                }

                next_handler();
            };
        }
    );
};
</code></pre>
<p>Controller file:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// controllers/!.js</span>
<span class="hljs-keyword">var</span> app = <span class="hljs-keyword">require</span>(<span class="hljs-string">'ifnode'</span>)(),
    main_controller = app.Controller({
        forbidden_ip: <span class="hljs-string">'127.0.0.1'</span>
    });

main_controller.get({ skip_ip: <span class="hljs-string">'10.10.10.1'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.send(<span class="hljs-string">'get handler'</span>);
});
main_controller.<span class="hljs-keyword">use</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request, response)</span> </span>{
    response.send(<span class="hljs-string">'use handler'</span>);
});
</code></pre>
<p>Test case:</p>
<pre><code>curl localhost:<span class="hljs-number">8080</span> -H x-forwarded-<span class="hljs-keyword">for</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> # status <span class="hljs-number">401</span>, <span class="hljs-keyword">Access</span> denied <span class="hljs-keyword">for</span> user<span class="hljs-symbol">'s</span> ip
curl localhost:<span class="hljs-number">8080</span> -H x-forwarded-<span class="hljs-keyword">for</span>=<span class="hljs-number">10.10</span>.<span class="hljs-number">10.1</span> # status <span class="hljs-number">200</span>, <span class="hljs-keyword">use</span> handler
</code></pre><h2 id="real-examples">Real examples</h2>
<ul>
<li><strong><a href="https://github.com/ifnode/auth">ifnode-auth</a></strong></li>
</ul>
